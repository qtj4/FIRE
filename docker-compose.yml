# docker compose up — поднимает весь стек, включая evaluation-service, kafka-ui, prometheus, grafana.
#
# Порты (host):
#   1111  postgres
#   2222  redis
#   3333  zookeeper
#   4444  kafka
#   6666  keycloak
#   7777  minio API  8888  minio console
#   8081  ticket-intake-service
#   8092  evaluation-service
#   5000  twilio-voice
#   8090  kafka-ui
#   9091  prometheus
#   3001  grafana (admin / admin123)
#   3111  frontend
#
version: "3.9"

services:

  postgres:
    image: postgres:16-alpine
    container_name: fire-postgres
    environment:
      POSTGRES_DB: fire
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    ports:
      - "1111:5432"
    volumes:
      - fire_postgres_data:/var/lib/postgresql/data
      - ./evaluation-service/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - fire-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d fire"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: fire-redis
    command: redis-server --requirepass ${REDIS_PWD:-fire123} --appendonly yes
    ports:
      - "2222:6379"
    volumes:
      - fire_redis_data:/data
    networks:
      - fire-network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PWD:-fire123}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: fire-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "3333:2181"
    volumes:
      - fire_zookeeper_data:/var/lib/zookeeper/data
      - fire_zookeeper_log:/var/lib/zookeeper/log
    networks:
      - fire-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: fire-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: fire-zookeeper:2181
      KAFKA_LISTENERS: SASL_PLAINTEXT://:9092,PLAINTEXT://:29092
      KAFKA_ADVERTISED_LISTENERS: SASL_PLAINTEXT://localhost:9092,PLAINTEXT://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: SASL_PLAINTEXT:SASL_PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_SASL_ENABLED_MECHANISMS: PLAIN
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: PLAIN
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_jaas.conf"
      KAFKA_ZOOKEEPER_SASL_ENABLED: "false"
      ZOOKEEPER_SASL_ENABLED: "false"
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_DELETE_TOPIC_ENABLE: "true"
    volumes:
      - ./kafka_jaas.conf:/etc/kafka/kafka_jaas.conf
      - fire_kafka_data:/var/lib/kafka/data
    networks:
      - fire-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:29092"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: fire-kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: fire-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    networks:
      - fire-network
    restart: unless-stopped

  ticket-intake-service:
    build:
      context: .
      dockerfile: ticket-intake-service/Dockerfile
    container_name: fire-ticket-intake
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/fire
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      EVALUATION_BASE_URL: http://evaluation-service:8092
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - fire-network
    restart: unless-stopped

  evaluation-service:
    build:
      context: ./evaluation-service
      dockerfile: Dockerfile
    container_name: fire-evaluation
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8092:8092"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SERVER_PORT: "8092"
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/fire
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: none
      SPRING_JPA_SHOW_SQL: "false"
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: "6379"
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PWD:-fire123}
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,prometheus,metrics
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always
      MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED: "true"
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_KZ_ENKI_FIRE_EVALUATION_SERVICE: INFO
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_KAFKA: INFO
    networks:
      - fire-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  twilio-voice:
    build:
      context: .
      dockerfile: Dockerfile.twilio
    container_name: fire-twilio-voice
    ports:
      - "5000:5000"
    environment:
      BACKEND_URL: ${TWILIO_BACKEND_URL:-http://twilio-voice:5000/receive-recording}
      MAX_RECORD_SECONDS: ${TWILIO_MAX_RECORD_SECONDS:-60}
      VOICE_LANG: ${TWILIO_VOICE_LANG:-ru-RU}
      VOICE_NAME: ${TWILIO_VOICE_NAME:-alice}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_TRANSCRIBE_MODEL: ${OPENAI_TRANSCRIBE_MODEL:-gpt-4o-mini-transcribe}
      TICKET_WEBHOOK_URL: ${TICKET_WEBHOOK_URL:-http://2.133.130.153:5678/webhook/ticket}
      TICKET_API_KEY: ${TICKET_API_KEY:-}
      TICKET_CSV_TEMPLATE: "${TICKET_CSV_TEMPLATE:-a154a8e6-439d-4a7b-86e8-56ef94b18ee2,Мужской,1999-12-31 0:00,{text},data_error.png,VIP,Казахстан,Восточно-Казахстанская,Усть-Каменогорск  ул. Казахстан,30}"
      PORT: "5000"
    networks:
      - fire-network
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: fire-prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./evaluation-service/prometheus.yml:/etc/prometheus/prometheus.yml
      - fire_prometheus_data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.console.libraries=/etc/prometheus/console_libraries
      - --web.console.templates=/etc/prometheus/consoles
      - --storage.tsdb.retention.time=200h
      - --web.enable-lifecycle
    networks:
      - fire-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: fire-grafana
    depends_on:
      - prometheus
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - fire_grafana_data:/var/lib/grafana
      - ./evaluation-service/grafana/provisioning:/etc/grafana/provisioning
    networks:
      - fire-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8092}
        VITE_INTAKE_API_BASE_URL: ${VITE_INTAKE_API_BASE_URL:-http://localhost:8082}
    container_name: fire-frontend
    ports:
      - "3111:80"
    networks:
      - fire-network
    restart: unless-stopped

#  n8n:
#    image: n8nio/n8n:latest
#    ports:
#      - "5678:5678"
#    environment:
#      - N8N_HOST=localhost
#      - N8N_PORT=5678
#      - N8N_PROTOCOL=http
#      - NODE_ENV=production
#      - GENERIC_TIMEZONE=Asia/Qyzylorda
#      - TZ=Asia/Qyzylorda
#      # чтобы не ругался на "не https" при локалке
#      - N8N_SECURE_COOKIE=false
#    volumes:
#      - fire_n8n_data:/home/node/.n8n

volumes:
  fire_postgres_data:
  fire_redis_data:
  fire_keycloak_data:
  fire_minio_data:
  fire_n8n_data:
  fire_prometheus_data:
  fire_grafana_data:
  fire_zookeeper_data:
  fire_zookeeper_log:
  fire_kafka_data:


networks:
  fire-network:
    driver: bridge
